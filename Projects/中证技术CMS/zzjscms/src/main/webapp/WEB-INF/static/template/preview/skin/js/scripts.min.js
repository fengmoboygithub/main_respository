function handleSaveLayout(){
	var e=$(".demo").html();
	if(e!=window.demoHtml){
		/*saveLayout();*/
		window.demoHtml=e
	}
}
function handleJsIds(){
	handleModalIds();
	handleAccordionIds();
	handleCarouselIds();
	handleTabsIds();
	handlePagesIds();
	handleTopIds();
	handleBottomIds();
}
function handleAccordionIds(){
	var e=$(".demo #myAccordion");
	var t=randomNumber();
	var n="panel-"+t;
	var r;e.attr("id",n);
	e.find(".panel").each(function(e,t){
		r="panel-element-"+randomNumber();
		$(t).find(".panel-title").each(function(e,t){
			$(t).attr("data-parent","#"+n);
			$(t).attr("href","#"+r)});
			$(t).find(".panel-collapse").each(function(e,t){
				$(t).attr("id",r)
			})
		})
}
function handleCarouselIds(){
	var e=$(".demo #myCarousel");
	var t=randomNumber();
	var n="carousel-"+t;
	e.attr("id",n);
	e.find(".carousel-indicators li").each(function(e,t){
		$(t).attr("data-target","#"+n)
	});
	e.find(".left").attr("href","#"+n);
	e.find(".right").attr("href","#"+n)
}
function handleModalIds(){
	var e=$(".demo #myModalLink");
	var t=randomNumber();
	var n="modal-container-"+t;
	var r="modal-"+t;
	e.attr("id",r);
	e.attr("href","#"+n);
	e.next().attr("id",n)
}

//拖动网站顶部触发的处理函数
function handleTopIds(){
	var e=$(".demo .topBy");
	var t=randomNumber();
	var n="top-"+t;
	e.attr("class",n);
	//网站顶部参数模态框
	var e2=$(".demo [data-target='#topParamModal']");
	if(e2.length>0){
		var n2="#topParamModal-"+t;
		e2.attr("data-target",n2);
		//网站顶部组件填写加载参数模态框
		var topParamModalDiv = $("<div>",{"class":"modal fade","id":"topParamModal-"+t,"role":"dialog","aria-labelledby":"topParamModalLabel-"+t,"aria-hidden":"true"})
		$("body").append(topParamModalDiv);
		//监听模态框事件
		$('#'+"topParamModal-"+t).on('hidden.bs.modal', function (e) {
			e.preventDefault();
			var obj=$(".demo [data-target='#topParamModal-"+t+"']");
			var topParamModal = $("#topParamModal-"+t);
			var ajaxUrl = topParamModal.find("[id='ajaxUrl']").val();
			var dealMethod = topParamModal.find("[id='dealMethod']").val();
			var dataMap = {
				"targetId":n,
				"ajaxUrl":ajaxUrl,
				"dealMethod":dealMethod
			};
			writeElm(obj,dataMap);
		})
	}
}

//拖动网站底部触发的处理函数
function handleBottomIds(){
	var e=$(".demo .bottomBy");
	var t=randomNumber();
	var n="bottom-"+t;
	e.attr("class",n);
	//网站底部参数模态框
	var e2=$(".demo [data-target='#bottomParamModal']");
	if(e2.length>0){
		var n2="#bottomParamModal-"+t;
		e2.attr("data-target",n2);
		//网站底部组件填写加载参数模态框
		var bottomParamModalDiv = $("<div>",{"class":"modal fade","id":"bottomParamModal-"+t,"role":"dialog","aria-labelledby":"bottomParamModalLabel-"+t,"aria-hidden":"true"})
		$("body").append(bottomParamModalDiv);
		//监听模态框事件
		$('#'+"bottomParamModal-"+t).on('hidden.bs.modal', function (e) {
			e.preventDefault();
			var obj=$(".demo [data-target='#bottomParamModal-"+t+"']");
			var bottomParamModal = $("#bottomParamModal-"+t);
			var ajaxUrl = bottomParamModal.find("[id='ajaxUrl']").val();
			var dealMethod = bottomParamModal.find("[id='dealMethod']").val();
			var dataMap = {
				"targetId":n,
				"ajaxUrl":ajaxUrl,
				"dealMethod":dealMethod
			};
			writeElm(obj,dataMap);
		})
	}
}

//拖动选项卡触发的处理函数
function handleTabsIds(){
	var e=$(".demo #myTabs");
	var t=randomNumber();
	var n="tabs-"+t;
	e.attr("id",n);
	e.find(".tab-pane").each(function(e,t){
		var n=$(t).attr("id");
		var r="panel-"+randomNumber();
		$(t).attr("id",r);
		$(t).parent().parent().find("a[href=#"+n+"]").attr("href","#"+r)
	});
	//选项卡参数模态框
	var e2=$(".demo [data-target='#tabParamModal']");
	if(e2.length>0){
		var n2="#tabParamModal-"+t;
		e2.attr("data-target",n2);
		//选项卡组件填写加载参数模态框
		var tabParamModalDiv = $("<div>",{"class":"modal fade","id":"tabParamModal-"+t,"role":"dialog","aria-labelledby":"tabParamModalLabel-"+t,"aria-hidden":"true"})
		$("body").append(tabParamModalDiv);
		//监听模态框事件
		$('#'+"tabParamModal-"+t).on('hidden.bs.modal', function (e) {
			e.preventDefault();
			var obj=$(".demo [data-target='#tabParamModal-"+t+"']");
			var tabParamModal = $("#tabParamModal-"+t);
			var ajaxUrl = tabParamModal.find("[id='ajaxUrl']").val();
			var dealMethod = tabParamModal.find("[id='dealMethod']").val();
			//将class为column段落排序化
			dealMethod+="\n\t\t\t\t$('#'+targetId).find('.column').sortable({ connectWith:'.column', opacity:.35 });"
			var dataMap = {
				"tabId":n,
				"ajaxUrl":ajaxUrl,
				"dealMethod":dealMethod
			};
			writeElm(obj,dataMap);
		})
	}
}
//拖动分页组件触发的处理函数
function handlePagesIds(){
	var t=randomNumber();
	//分页条
	var e=$(".demo #myPages");
	var n="pages-"+t;
	e.attr("id",n);
	//数据显示区
	var e1=$(".demo #myPageDatas");
	var n1="datas-"+t;
	e1.attr("id",n1);
	e.attr("randomNum",t);
	//分页参数模态框
	var e2=$(".demo [data-target='#pageParamModal']");
	if(e2.length>0){
		var n2="#pageParamModal-"+t;
		e2.attr("data-target",n2);
		//分页组件填写加载参数模态框
		var pageParamModalDiv = $("<div>",{"class":"modal fade","id":"pageParamModal-"+t,"role":"dialog","aria-labelledby":"pageParamModalLabel-"+t,"aria-hidden":"true"})
		$("body").append(pageParamModalDiv);
		//监听模态框事件
		$('#'+"pageParamModal-"+t).on('hidden.bs.modal', function (e) {
			e.preventDefault();
			var obj=$(".demo [data-target='#pageParamModal-"+t+"']");
			var pageParamModal = $("#pageParamModal-"+t);
			var pageBarId = obj.parent().next().next().find('.pagination').attr('id');
			var pageDataId = obj.parent().next().next().find('.pageData').attr('id');
			var ajaxUrl = pageParamModal.find("[id='ajaxUrl']").val();
			var dealMethod = pageParamModal.find("[id='dealMethod']").val();
			var dataMap = {
				"pageBarId":pageBarId,
				"pageDataId":pageDataId,
				"ajaxUrl":ajaxUrl,//"http://127.0.0.1/portal/xxpl/smInfomationListShow.co"
				"dealMethod":dealMethod//"console.log(json);"
			};
			writeElm(obj,dataMap);
		})
	}
	
}
function randomNumber(){
	return randomFromInterval(1,1e6)
}
function randomFromInterval(e,t){
	return Math.floor(Math.random()*(t-e+1)+e)
}
function gridSystemGenerator(){
	$(".lyrow .preview input").bind("keyup",function(){
		var e=0;
		var t="";
		var n=false;
		var r=$(this).val().split(" ",12);
		$.each(r,function(r,i){
			if(!n){
				if(parseInt(i)<=0) n=true;
				e=e+parseInt(i);
				t+='<div class="col-md-'+i+' column"></div>'
			}
		});
		if(e==12&&!n){
			$(this).parent().next().children().html(t);
			$(this).parent().prev().show()
		}else{
			$(this).parent().prev().hide()
		}
	})
}
function configurationElm(e,t){
	$(".demo").delegate(".configuration > a:not(.write)","click",
	function(e){
		e.preventDefault();
		var t=$(this).parent().next().next().children();
		$(this).toggleClass("active");
		t.toggleClass($(this).attr("rel"))
	});
	$(".demo").delegate(".configuration .dropdown-menu a","click",
	function(e){
		e.preventDefault();
		var t=$(this).parent().parent();
		var n=t.parent().parent().next().next().children();
		t.find("li").removeClass("active");
		$(this).parent().addClass("active");
		var r="";
		t.find("a").each(function(){
			r+=$(this).attr("rel")+" "
		});
		t.parent().removeClass("open");
		n.removeClass(r);
		n.addClass($(this).attr("rel"))
	})
}
function removeElm(){
	$(".demo").delegate(".remove","click",
	function(e){
		e.preventDefault();
		$(this).parent().find(".write").each(function(){
			var pageParamModalId = $(this).attr("data-target");
			$(pageParamModalId).remove();
		});		
		$(this).parent().remove();
		if(!$(".demo .lyrow").length>0){
			clearDemo()
		}
	})
}
//将js脚本中注释去掉
function replaceAllStr(str){
	if(str){
		str = str.replace(/\/\*/g,"").replace(/\*\//g,"");
	}
	return str;
}
//将模板与动态数据合并
function fillTempData(tempStr,dataMap){
	var resultStr = tempStr;
	var defaultDataMap = {
		"pageBarId":"pageBarId",
		"pageDataId":"pageDataId",
		"ajaxUrl":"http://127.0.0.1/portal/xxpl/pageListTest.co",
		"dealMethod":"console.log(json);"
	};
	var dataMap = $.extend(defaultDataMap, dataMap||{});
	for (key in dataMap)
	{
		resultStr = resultStr.replace(new RegExp("\\$\\{"+key+"\\}","gi"),dataMap[key]);
	}
	return resultStr;
}
//将js模板脚本内容与动态的数据合并
function writeElm(obj,dataMap) { 
	var scriptSrc = "";
	obj.parent().next().next().find('script').each(function(){
		scriptSrc += this.innerHTML;
	});
	
	scriptSrc = replaceAllStr(scriptSrc);
	
	scriptSrc = fillTempData(scriptSrc,dataMap);
	obj.parent().next().next().find('script').each(function(){
		this.innerHTML = scriptSrc;
	});
}
function clearDemo(){
	$(".demo").empty()
}
function removeMenuClasses(){
	$("#menu-layoutit li button").removeClass("active")
}
function changeStructure(e,t){
	$("#download-layout ."+e).removeClass(e).addClass(t)
}
function cleanHtml(e){
	$(e).parent().append($(e).children().html())
}
//清除<script>标签体
function clenScript(str){
	if(str){
		str = str.replace(/\<script\>([\s\S]*)\<\/script\>/g,"");
	}
	return str;
}
function downloadLayoutSrc(){
	//将<script>标签内容获取到存入变量中
	var scriptSrc = "";
	$(".demo").find("script").each(function(){
		//console.log(this.innerHTML);
		scriptSrc += this.innerHTML;
		//$(this).remove();
	});
	var e="";
	$("#download-layout").children().html($(".demo").html());
	var t=$("#download-layout").children();
	t.find(".preview, .configuration, .drag, .remove").remove();
	t.find(".lyrow").addClass("removeClean");
	t.find(".box-element").addClass("removeClean");
	t.find(".box-element").find(".removeClean").each(function(){
		cleanHtml(this)
	});
	t.find(".lyrow .lyrow .lyrow .lyrow .lyrow .removeClean").each(function(){
		cleanHtml(this)
	});
	t.find(".lyrow .lyrow .lyrow .lyrow .removeClean").each(function(){
		cleanHtml(this)
	});
	t.find(".lyrow .lyrow .lyrow .removeClean").each(function(){
		cleanHtml(this)
	});
	t.find(".lyrow .lyrow .removeClean").each(function(){
		cleanHtml(this)
	});
	t.find(".lyrow .removeClean").each(function(){
		cleanHtml(this)
	});
	
	t.find(".removeClean").each(function(){
		cleanHtml(this)
	});
	t.find(".removeClean").remove();
	$("#download-layout .column").removeClass("ui-sortable");
	$("#download-layout .row").removeClass("clearfix").children().removeClass("column");
	/*if($("#download-layout .container").length>0){
		changeStructure("row-fluid","row")
	}*/
	$("#download-layout").find("script").each(function(){
		$(this).remove();
	});
	formatSrc=$.htmlClean($("#download-layout").html(),{
		format:true,
		allowedAttributes:[["id"],["class"],["data-toggle"],["data-target"],["data-parent"],["role"],["data-dismiss"],["aria-labelledby"],["aria-hidden"],["data-slide-to"],["data-slide"]]
	});
	//console.log(formatSrc);
	var scriptStr = formatSrc+"\n\t\t";
	if(scriptSrc){
		scriptStr+=("<script>"+scriptSrc+"</script>");
	}
	$("#download-layout").html(formatSrc);
	$("#downloadModal textarea").empty();
	$("#downloadModal textarea").val(scriptStr);
}
var currentDocument=null;
var timerSave=2e3;
var demoHtml=$(".demo").html();
$(window).resize(function(){
	$("body").css("min-height",$(window).height()-90);
	$(".demo").css("min-height",$(window).height()-160)
});
$(document).ready(function(){
	$("body").css("min-height",$(window).height()-90);
	$(".demo").css("min-height",$(window).height()-160);
	$(".demo, .demo .column").sortable({
		connectWith:".column",
		opacity:.35,
		handle:".drag"
	});
	$(".sidebar-nav .lyrow").draggable({
		connectToSortable:".demo",
		helper:"clone",
		handle:".drag",
		drag:function(e,t){
			t.helper.width(400)
		},
		stop:function(e,t){
			$(".demo .column").sortable({
				opacity:.35,
				connectWith:".column"
			})
		}
	});
	$(".sidebar-nav .box").draggable({
		connectToSortable:".column",
		helper:"clone",
		handle:".drag",
		drag:function(e,t){
			t.helper.width(400)
		},
		stop:function(){
			handleJsIds()
		}
	});
	$('#downloadModal').on('shown.bs.modal', function (e) {
		e.preventDefault();
		downloadLayoutSrc()
	})
	$("#download").click(function(){
		downloadLayout();
		return false
	});
	$("#downloadhtml").click(function(){
		downloadHtmlLayout();
		return false
	});
	$("#edit").click(function(){
		$("body").removeClass("devpreview sourcepreview");
		$("body").addClass("edit");
		removeMenuClasses();
		$(this).addClass("active");
		return false
	});
	$("#clear").click(function(e){
		e.preventDefault();
		clearDemo()
	});
	$("#devpreview").click(function(){
		$("body").removeClass("edit sourcepreview");
		$("body").addClass("devpreview");
		removeMenuClasses();
		$(this).addClass("active");
		return false
	});
	$("#sourcepreview").click(function(){
		$("body").removeClass("edit");
		$("body").addClass("devpreview sourcepreview");
		removeMenuClasses();
		$(this).addClass("active");
		return false
	});
	$(".nav-header").click(function(){
		$(".sidebar-nav .boxes, .sidebar-nav .rows").hide();
		$(this).next().slideDown()
	});
	removeElm();
	configurationElm();
	gridSystemGenerator();
	/*setInterval(function(){
		handleSaveLayout()
	},timerSave);*/
})
